# some boiler plate generated by chat gpt
name: CI Workflow for Snakemake and pytest

on:
  push:
    branches:
      - main  # Trigger the workflow when pushing to the main branch
      - py-tests # when pushing to py-tests branch for dev
  pull_request:
    branches:
      - main  # Trigger on pull requests to main branch

jobs:
  run-tests:
    runs-on: ubuntu-latest  # Set the environment to Ubuntu

    steps:
    # Step 1: Checkout the repository
    - uses: actions/checkout@v4

    # Step 2: Set up Conda with Mamba and built-in caching
    - name: Set up Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-version: 'latest'
        environment-file: workflow/envs/environment.yaml
        activate-environment: pypsa-china
        auto-activate-base: false
        use-mamba: true
        cache-downloads: true  # Enable built-in download caching
        cache-environment: true  # Enable built-in environment caching
        condarc: |
          channels:
            - conda-forge
            - bioconda
          channel_priority: strict
          pip_interop_enabled: true  # Enable pip/conda interoperability
          quiet: true  # Reduce output for CI

    # Step 3: Additional manual cache for better control
    - name: Cache Conda packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.conda/pkgs
          ~/.cache/mamba
        key: ${{ runner.os }}-conda-pkgs-${{ hashFiles('workflow/envs/environment.yaml') }}
        restore-keys: |
          ${{ runner.os }}-conda-pkgs-

    # Step 4: Show environment info
    - name: Show environment
      shell: bash -el {0}
      run: |
        mamba info
        mamba list
        python -V
        pytest --version
    - name: Run pytest
      shell: bash -el {0}
      run: |
        pytest -v -s
